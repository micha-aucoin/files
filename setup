#!/usr/bin/env bash

# if running as root, change HOME back to the user's HOME
if [[ -n "${SUDO_USER:-}" ]]; then
  TARGET_HOME="$(getent passwd "$SUDO_USER" | cut -d: -f6)"
else
  TARGET_HOME="$HOME"
fi

# Absolute path to this dotfiles repo (directory containing this script)
REPO_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

ln -sfv "$REPO_DIR/tmux-sessionizer"         /usr/local/bin
ln -sfv "$REPO_DIR/.vim/compiler/pyqf-run"   /usr/local/bin
ln -sfv "$REPO_DIR/.vim"                     "$TARGET_HOME"/.vim
ln -sfv "$REPO_DIR/.vimrc"                   "$TARGET_HOME"/.vimrc
ln -sfv "$REPO_DIR/.tmux.conf"               "$TARGET_HOME"/.tmux.conf
ln -sfv "$REPO_DIR/.bash_aliases"            "$TARGET_HOME"/.bash_aliases

FILE="$TARGET_HOME/.bashrc"
MARKER_BEGIN="# >>> dotfiles custom config >>>"
MARKER_END="# <<< dotfiles custom config <<<"

custom_dotfiles() 
{
	cat <<-EOF

		$MARKER_BEGIN
		if [ -f "$REPO_DIR/.bashrc" ]; then
		  source "$REPO_DIR/.bashrc"
		fi
		$MARKER_END
	EOF
}

print_color()
{
	local color code prefix
	color="${1^^}"; shift

	case "$color" in
		RED)   code='31'; prefix='- ' ;;
		GREEN) code='32'; prefix='+ ' ;;
		*)     echo "$color color not implemented" >&2; return 1 ;;
	esac

	while IFS= read -r line; do
		printf "\033[%sm%s%s\033[0m\n" "$code" "$prefix" "$line"
	done
}

echo
echo "About to make the following changes to $FILE:"
sed -n "/$MARKER_BEGIN/,/$MARKER_END/p" "$FILE" | print_color red
custom_dotfiles | print_color green

read -p "Continue? (y/N) " confirm
if [[ "$confirm" != "y" ]]; then
	echo "Aborted."
	exit 0
fi

sed -i "/$MARKER_BEGIN/,/$MARKER_END/d" "$FILE"

custom_dotfiles >> "$FILE"
